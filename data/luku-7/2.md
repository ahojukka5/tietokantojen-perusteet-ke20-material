---
path: '/luku-7/2'
title: 'Indeksit'
hidden: false
---

_Indeksi_ on tietokannan taulun yhteydessä oleva aputietorakenne,
jonka tavoitteena on tehostaa tauluun liittyvien kyselyiden suorittamista.
Indeksin avulla tietokantajärjestelmä voi selvittää tehokkaasti,
missä päin taulua on rivi tai rivejä,
joiden sarakkeissa on kyselyn hakuehtoa vastaava arvo.

## Indeksin toiminta

Tavallinen tapa toteuttaa indeksi on muodostaa puurakenne,
jossa taulun rivit on järjestetty tietyn sarakkeen arvon perusteella.
Tarkastellaan esimerkkinä taulua `Tuotteet`,
jonka sisältönä on:

```x
id          nimi        hinta     
----------  ----------  ----------
1           retiisi     7         
2           porkkana    5         
3           nauris      4         
4           lanttu      8         
5           selleri     4         
```

Oletetaan lisäksi, että haluamme tehostaa kyselyitä muotoa

```sql
SELECT nimi FROM Tuotteet WHERE hinta=?;
```

jotka etsivät tuotteita hinnan perusteella.
Niinpä tarvitsemme indeksin, joka on muodostettu
sarakkeen `hinta` perusteella.
Tällainen indeksi voisi näyttää suunnilleen tältä:

<img src="/indeksi1.png">

Ideana on, että voimme löytää puusta tehokkaasti
halutut rivit lähtemällä liikkeelle ylimmästä nuolesta.
Puussa arvo _x_ tarkoittaa,
että jos hinta on enintään _x_,
meidän tulee jatkaa vasemmalle,
ja muuten oikealle.
Lopulta päädymme laatikoihin,
joissa kussakin on rivin hinta ja id,
järjestettynä hinnan mukaan.
Esimerkiksi jos haluamme löytää rivit,
joissa hinta on 5, kuljemme puussa seuraavasti:

<img src="/indeksi2.png">

Näin päädyimme laatikkoon 5/2,
mikä tarkoittaa, että tietokannassa on rivi,
jonka hinta on 5 ja id on 2.
Indeksin hyötynä oli, että löysimme rivin suoraan hinnan perusteella
eikä meidän tarvinnut käydä läpi taulun kaikkia rivejä.

Tutustumme tarkemmin puurakenteisiin kurssilla
_Tietorakenteet ja algoritmit_.
Tietokannoissa tyypillinen indekseissä käytettävä
puurakenne on B+-puu, jonka erikoisuutena on,
että se soveltuu hyvin levyllä käsiteltäväksi.

## Indeksi käytännössä

Yleensä taulun pääavaimen (eli käytännössä id-numeron)
perusteella muodostetaan indeksi automaattisesti,
eli oletuksena voimme etsiä tehokkaasti rivejä id:n perusteella.
Tämän lisäksi voimme halutessamme luoda itse lisää indeksejä
hakuja tehostamaan.

Indeksi luodaan komennolla `CREATE INDEX`.
Esimerkiksi seuraava komento luo indeksin
taulun `Tuotteet` sarakkeelle `hinta`:

```sql
CREATE INDEX idx_hinta ON Tuotteet (hinta);
```

Tässä `idx_hinta` on indeksin nimi, jolla voimme viitata siihen myöhemmin.
Meidän ei tarvitse tehdä muuta,
vaan tämän jälkeen tietokantajärjestelmä pitää huolen indeksin
ylläpidosta ja osaa käyttää indeksiä tarvittaessa tehostamaan kyselyjä,
joissa taulusta `Tuotteet` haetaan rivejä sarakkeen `hinta` perusteella.

Indeksin olemassaolon pystyy havaitsemaan,
kun pyydämme tietokantajärjestelmää selittämään kyselyn.
Esimerkiksi seuraava näyttää kyselyn suoritustavan
ennen indeksin luontia ja indeksin luonnin jälkeen:

```x
sqlite> EXPLAIN QUERY PLAN SELECT nimi FROM Tuotteet WHERE hinta=5;
0|0|0|SCAN TABLE Tuotteet
sqlite> CREATE INDEX idx_hinta ON Tuotteet (hinta);
sqlite> EXPLAIN QUERY PLAN SELECT nimi FROM Tuotteet WHERE hinta=5;
0|0|0|SEARCH TABLE Tuotteet USING INDEX idx_hinta (hinta=?)
```

Ennen indeksin lisäämistä koko taulu täytyy käydä läpi
(`SCAN TABLE Tuotteet`),
mutta indeksin lisäämisen jälkeen sitä voi käyttää apuna kyselyssä
(`SEARCH TABLE Tuotteet`).

## Indeksin varjopuolet
